name: Tests for merging a PR on main

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Install dependencies
        run: yarn install

      - name: Run tests
        id: test
        run: yarn test

      - name: Add label based on test results
        if: always()
        uses: actions/github-script@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const isPassing = steps.test.outcome == 'success';
            const label = isPassing ? 'ci-passing' : 'ci-failing';
            const color = isPassing ? '0E8A16' : 'B60205';

            // Check if the label already exists
            const { data: existingLabel } = await github.issues.getLabel({
              owner,
              repo,
              name: label,
            });

            if (!existingLabel) {
              // Create the label if it doesn't exist
              await github.issues.createLabel({
                owner,
                repo,
                name: label,
                color,
              });
            }

            // Add the label to the pull request
            await github.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [label],
            });
