name: Tests for merging a PR on main

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Install dependencies
        run: yarn install

      - name: Run tests
        id: test
        run: yarn test

      - name: Add label based on test results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pull_request_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          owner=$(jq --raw-output .repository.owner.login "$GITHUB_EVENT_PATH")
          repo=$(jq --raw-output .repository.name "$GITHUB_EVENT_PATH")

          if [ ${{ steps.test.outputs.return-code }} -eq 0 ]; then
            label='ci-passing'
            color='0E8A16'
          else
            label='ci-failing'
            color='B60205'
          fi

          label_exists=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$owner/$repo/labels/$label")

          if [ -z "$label_exists" ]; then
            response=$(curl -X POST -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "{\"name\": \"$label\", \"color\": \"$color\"}" \
              "https://api.github.com/repos/$owner/$repo/labels")

            if [ $(jq -r '.name' <<< "$response") != "$label" ]; then
              echo "Failed to create the label: $label"
              exit 1
            fi
          fi

          curl -X POST -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "[]" \
            "https://api.github.com/repos/$owner/$repo/issues/$pull_request_number/labels"
